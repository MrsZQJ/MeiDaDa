<!DOCTYPE html>
<html>
<script>
    function getCookie() {
        let Cookieaa = document.cookie.split(";");
        for (var i = 0; i < Cookieaa.length; i++) {
            var arr = Cookieaa[i].split("=");
            if (arr[0] == " token") {
                return arr[1]
            }
        }
    }
    const yanzheng = getCookie()
    if (!yanzheng) {
        location.href = "login.html";
    }
</script>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>美哒哒</title>
    <link rel="stylesheet" href="./static/bootstrap-4.3.1-dist/bootstrap-4.3.1-dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="./static/layui/css/layui.css">
    <link rel="stylesheet" href="./static/css/base.css">
</head>

<body class="layui-layout-body">
    <div class="layui-layout layui-layout-admin">
        <div class="layui-header">
            <!-- <div class="layui-logo">layui 后台布局</div> -->
            <!-- 头部区域（可配合layui已有的水平导航） -->
            <ul class="layui-nav layui-layout-left">

                <li class="layui-nav-item"><a href="./quanxian.html"><i class="layui-icon layui-icon-release"
                            style="font-size: 14px; color: #ffffff;">&nbsp;&nbsp;权限管理</i> </a></li>
            </ul>
            <ul class="layui-nav layui-layout-right">
                <li class="layui-nav-item" id="parentChangePassword"><a href="javascript:;"><i
                            class="layui-icon layui-icon-password" style="font-size: 14px; color: #ffffff;"
                            id="changePassWorld">&nbsp;&nbsp;修改密码</i> </a></li>
                <li class="layui-nav-item" id="getlayout"><a href="javascript:;"><i
                            class="layui-icon layui-icon-username"
                            style="font-size: 14px; color: #ffffff;">&nbsp;&nbsp;退出</i> </a></li>
            </ul>
        </div>

        <div class="layui-side layui-bg-black">
            <div class="layui-side-scroll">
                <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
                <ul class="layui-nav layui-nav-tree">
                    <li class="layui-nav-item layui-nav-itemed"><a href="./index.html">商户管理</a></li>
                    <li class="layui-nav-item"><a href="./shoping.html">拼团产品管理</a></li>
                    <li class="layui-nav-item"><a href="./tixian.html">提现管理</a></li>
                    <li class="layui-nav-item"><a href="./user.html">用户管理</a></li>
                    <li class="layui-nav-item"><a href="./quanxian.html">权限管理</a></li>
                </ul>
            </div>
        </div>

        <div class="layui-body">
            <!-- 内容主体区域 -->
            <div style="padding: 15px;">
                <div class="top">
                    <a href="javascript:;" class="addShangHu">+添加商户</a>
                    <div class="box">
                        <input type="text" id="searchPhone" placeholder="搜索手机号码">
                        <i id="searchIcon" class="layui-icon layui-icon-search"></i>
                    </div>
                </div>
                <table class="table" style="text-align: center;">
                    <thead>
                        <tr>
                            <th>序号</th>
                            <th>商户名称</th>
                            <th>手机号码</th>
                            <th>密码</th>
                            <th>地址</th>
                            <th>入驻时间</th>
                            <!-- <th>状态</th> -->
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody class="moban">
                        <tr>
                            <th>7</th>
                            <th>aa</th>
                            <th>bbb</th>
                            <th>cccc</th>
                            <th>ddddd</th>
                            <th>2019.7.13</th>
                            <th><input type="checkbox" name="yyy" lay-skin="switch" lay-text="ON|OFF" checked disabled>
                            </th>
                            <th>
                                <a href="javascript:edit();">编辑</a>&nbsp;&nbsp;&nbsp;
                                <a href="javascript:;">停用</a>&nbsp;&nbsp;&nbsp;
                                <a href="javascript:DetailTr();;">删除</a>
                            </th>
                        </tr>

                    </tbody>
                </table>
                <div id="demoaaa"></div>
            </div>
        </div>
    </div>
</body>
<script src="./static/jquery-3.3.1.min.js"></script>
<script src="./static/jquery.cookie.js"></script>
<script src="./static/template-web.js"></script>
<script src="./static/bootstrap-4.3.1-dist/bootstrap-4.3.1-dist/js/bootstrap.min.js"></script>
<script src="./static/layui/layui.js"></script>
<script src="./base.js"></script>
<!-- 修改密码 -->
<script type="text/html" id="changePassWorldbbb">
    <form class="layui-form" id="changePassWorldaaa" style="padding: 20px;">
        <div class="layui-form-item">
            <label class="layui-form-label">旧密码</label>
            <div class="layui-input-block">
                <input id="oldNum" type="text" name="old" autocomplete="off" placeholder="请输入旧密码" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">新密码</label>
            <div class="layui-input-block">
                <input id="newNum" type="text" name="new" autocomplete="off" placeholder="请输入新密码" class="layui-input">
            </div>
        </div>

    </form>
</script>
<!-- 添加商户/编辑单个商户 -->
<script type="text/html" id="addShangHuXingXi" lay-filter="example">
    <form class="layui-form" id="addShangHuXingXiInput" style="padding: 20px;">
        <div class="layui-form-item">
            <label class="layui-form-label">商户名称</label>
            <div class="layui-input-block">
                <input type="text" name="nickname" autocomplete="off" placeholder="请输入商户名称"
                    class="layui-input nickname">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">手机号</label>
            <div class="layui-input-block">
                <input type="text" name="mobile" autocomplete="off" placeholder="请输入手机号" class="layui-input mobile">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">登录密码</label>
            <div class="layui-input-block">
                <input type="text" name="password" autocomplete="off" placeholder="请输入登录密码"
                    class="layui-input password">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">头像地址</label>
            <div class="layui-input-block">
                <input type="text" name="headUrl" autocomplete="off" placeholder="请输入头像地址" class="layui-input headUrl">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">生日</label>
            <div class="layui-input-block">
                <input type="text" name="birthday" class="layui-input birthday" id="test1" placeholder="yyyy-MM-dd">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">性别</label>
            <div class="layui-input-block">
                <select name="sex" style="display:none" class="status">
                    <option value="1">男</option>
                    <option value="2">女</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">头像地址</label>
            <div class="layui-input-block">
                <input type="text" name="source" autocomplete="off" placeholder="请输入头像地址" class="layui-input source">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">商户地址</label>
            <div class="layui-input-block">
                <input type="text" name="address" autocomplete="off" placeholder="请输入商户地址" class="layui-input address">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">类型</label>
            <div class="layui-input-block">
                <select name="type" style="display:none" class="type">
                    <!-- <option value="1">商户</option> -->
                    <option value="2">用户</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">状态</label>
            <div class="layui-input-block">
                <select name="statusOn" style="display:none" class="statusOn">
                    <option value="1">启用</option>
                    <option value="2">停用</option>
                </select>
            </div>
        </div>
    </form>
</script>
<!-- 模板生成表格 -->
<script type="text/html" id="tab">
    {{each list value}}
    <tr>
        <th>{{value.customerId}}</th>
        <th>{{value.nickname}}</th>
        <th>{{value.mobile}}</th>
        <th>{{value.password}}</th>
        <th>{{value.address}}</th>
        <th>{{value.createTime}}</th>
        </th>
        <th>
            <a href="javascript:edit({{value.customerId}});">编辑</a>&nbsp;&nbsp;&nbsp;
            <a
                href="javascript:changeStatu({{value}});">{{if value.status=='1'}}停用{{else}}启用{{/if}}</a>&nbsp;&nbsp;&nbsp;
            <a href="javascript:DetailTr({{value.customerId}});;">删除</a>
        </th>
    </tr>
    {{/each}}
</script>
<script>
    layui.use(['laypage', 'layer', 'laydate', 'form', 'element'], function () {
        window.layer = layui.layer;
        window.form = layui.form;
        window.element = layui.element;
        window.laydate = layui.laydate;
        window.laypage = layui.laypage
        mounted()
    });

    // 请求表格数据
    var current = NaN

    function fund(pageIndex) {
        var one = {
            pageIndex: pageIndex,
            pageSize: 10,
            keyword: $('#searchPhone').val(),
        }
        $.ajax({
            type: "post",
            url: `${baseUrl}/business/search`,
            data: JSON.stringify(one),
            dataType: "JSON",
            contentType: "application/json",
            headers: {
                'x-api-token': $.cookie('token')
            },
            success: function (response) {
                if (response.code == 200) {
                    $.each(response.data.items, function (indexInArray, valueOfElement) {
                        valueOfElement.createTime = new Date(valueOfElement.createTime)
                            .toLocaleDateString()
                    });
                    var html = template('tab', {
                        list: response.data.items
                    });
                    $('.moban').html(html);
                    laypage.render({
                        elem: 'demoaaa',
                        limit: 10,
                        curr: current,
                        count: response.data.total,
                        jump: function (obj, first) {
                            if (!first) {
                                current = obj.curr
                                fund(obj.curr)
                            }
                        }
                    });
                }
            }
        });
    }

    function mounted() {
        // 查询商户信息
        fund(1)
        // 修改密码
        $('#changePassWorld').on('click', function () {
            layer.open({
                type: 1,
                title: '修改密码',
                area: ['50%', '70%'],
                content: $('#changePassWorldbbb').html(),
                btn: ['确定', '取消'],
                success: function (index, layero) {
                    form.render();
                },
                yes: function (index, layero) {
                    // 打印提交的修改密码表单信息
                    var apt = {
                        app: $.cookie('username'),
                        oldPassword: $('#oldNum').val(),
                        password: $('#newNum').val(),
                        confirmPassword: $('#newNum').val()
                    }
                    $.ajax({
                        type: "POST",
                        contentType: "application/json",
                        dataType: "JSON",
                        headers: {
                            'x-api-token': $.cookie('token')
                        },
                        url: `${baseUrl}/changepassword`,
                        data: JSON.stringify(apt),
                        success: function (response) {
                            if (response.code == 200) {
                                layer.closeAll();
                                layer.msg(`账号为${$.cookie('username')}的密码修改成功!`);
                            } else {
                                layer.msg(response.msg);
                            }
                        }
                    });
                },
            });
        })
        // 退出登录
        $('#getlayout').on('click', function () {
            $.ajax({
                type: "get",
                contentType: "application/json",
                dataType: "JSON",
                headers: {
                    'x-api-token': $.cookie('token')
                },
                url: `${baseUrl}/logout`,
                success: function (response) {
                    console.log(response);
                    if (response.code == 200) {
                        $.removeCookie("token")
                        location.href = "login.html";
                    }
                }
            });
        })
        // 添加商户
        $('.addShangHu').on('click', function () {
            layer.open({
                type: 1,
                title: '添加商户',
                area: ['50%', '60%'],
                content: $('#addShangHuXingXi').html(),
                btn: ['确定', '取消'],
                success: function (index, layero) {
                    form.render();
                    // 初始化时间
                    laydate.render({
                        elem: '#test1',
                        value: new Date()
                    });
                    laydate.render({
                        elem: '#test5',
                        type: 'datetime',
                        value: new Date()
                    });
                },
                yes: function (index, layero) {
                    var myreg = /^[1][3,4,5,7,8][0-9]{9}$/;
                    if (!myreg.test($('.mobile').val())) {
                        layer.msg('请填写有效手机号!');
                        return false;
                    }
                    var fm = {
                        // customerId: 0,
                        address: $('.address').val(),
                        birthday: $('.birthday').val(),
                        headUrl: $('.headUrl').val(),
                        mobile: $('.mobile').val(),
                        nickname: $('.nickname').val(),
                        password: $('.password').val(),
                        // sex: parseInt($('.sex').val()),
                        source: $('.source').val(),
                        type: parseInt($('.type').val()),
                        status: $('.statusOn').val()
                    }

                    tianJia(fm)
                },
            });
        })

    }
    // 添加商户
    function tianJia(fm) {
        $.ajax({
            type: "post",
            url: `${baseUrl}/business`,
            data: JSON.stringify(fm),
            dataType: "JSON",
            contentType: "application/json",
            headers: {
                'x-api-token': $.cookie('token')
            },
            success: function (response) {
                if (response.code == 200) {
                    layer.closeAll();
                    layer.msg('添加商户成功!');
                    fund(1)
                } else {
                    layer.msg(response.msg);
                }
            }
        });
    }


    // 删除操作
    function DetailTr(id) {
        layer.open({
            type: 1,
            content: '<p style="text-align: center">点击确认删除</p>',
            btn: ['确定', '取消'],
            success: function (index, layero) {},
            yes: function (index, layero) {
                // layer.closeAll();
                // var zhongzhuan = $('table>tbody').children()[index - 1]
                // var id = $($(zhongzhuan).children()[0]).text()
                // console.log(index);

                $.ajax({
                    type: "DELETE",
                    contentType: "application/json",
                    dataType: "JSON",
                    headers: {
                        'x-api-token': $.cookie('token')
                    },
                    url: `${baseUrl}/business/${id}`,
                    success: function (response) {
                        if (response.code == 200) {
                            layer.closeAll();
                            layer.msg(`会员Id为${id}的信息修改成功!`);
                            fund(1)
                        }
                    }
                });
            },
        });
    }
    // 编辑操作
    function edit(id) {
        layer.open({
            type: 1,
            area: ['50%', '60%'],
            content: $('#addShangHuXingXi').html(),
            btn: ['确定', '取消'],
            success: function (layero, index) {
                form.render();
                // 初始化时间
                laydate.render({
                    elem: '#test1',
                    type: 'date',
                    value: new Date()
                });
                laydate.render({
                    elem: '#test5',
                    type: 'datetime',
                    value: new Date()
                });
                $.ajax({
                    type: "get",
                    contentType: "application/json",
                    dataType: "JSON",
                    headers: {
                        'x-api-token': $.cookie('token')
                    },
                    url: `${baseUrl}/business/${id}`,
                    success: function (response) {

                        response.data.birthday = new Date(response.data.birthday).toISOString()
                            .split('T')[0]
                        // console.log(response);

                        if (response.code == 200) {
                            $('.address').val(response.data.address)
                            $('.birthday').val(response.data.birthday)
                            $('.headUrl').val(response.data.headUrl)
                            $('.mobile').val(response.data.mobile)
                            $('.nickname').val(response.data.nickname)
                            $('.password').val(response.data.password)
                            $('.sex').val(response.data.sex)
                            $('.source').val(response.data.source)
                            $('.type').val(response.data.type)
                        }
                    }
                });
            },
            yes: function (layero, index) {
                var sub = {
                    address: $('.address').val(),
                    birthday: $('.birthday').val(),
                    headUrl: $('.headUrl').val(),
                    mobile: $('.mobile').val(),
                    nickname: $('.nickname').val(),
                    password: $('.password').val(),
                    sex: $('.sex').val(),
                    source: $('.source').val(),
                    type: $('.type').val(),
                }
                $.ajax({
                    type: "PUT",
                    contentType: "application/json",
                    dataType: "JSON",
                    headers: {
                        'x-api-token': $.cookie('token')
                    },
                    data: JSON.stringify(sub),
                    url: `${baseUrl}/business/${id}`,
                    success: function (response) {
                        if (response.code == 200) {
                            layer.closeAll();
                            layer.msg('修改商户成功!');
                            fund(1)
                        } else {
                            layer.msg(response.msg);
                        }
                    }
                });
            },
        });
    }

    function changeStatu(val) {
        var sta = {
            nickname: val.nickname,
            status: NaN
        }
        if (val.status == 1) {
            val.status = 2
        } else if (val.status == 2) {
            val.status = 1
        }
        // val.createTime=new Date(val.createTime).getTime()
        delete(val.createTime)
        // delete(val.mobile)
        console.log(val);
        $.ajax({
            type: "PUT",
            contentType: "application/json",
            dataType: "JSON",
            headers: {
                'x-api-token': $.cookie('token')
            },
            data: JSON.stringify(val),
            url: `${baseUrl}/business/${val.customerId}`,
            success: function (response) {
                if (response.code == 200) {
                    layer.closeAll();
                    layer.msg('修改商户状态成功!');
                    fund(1)
                } else {
                    layer.msg(response.msg);
                }
            }
        });
    }

    // 键盘回车按下事件
    $('#searchPhone').on('keyup', function (e) {
        if (event.keyCode == '13') {
            var myreg = /^[1][3,4,5,7,8][0-9]{9}$/;
            if (!myreg.test($('#searchPhone').val())) {
                layer.msg('请填写有效手机号!');
                return false;
            }
            fund(1)
        }
    })

    //点击搜索图标事件
    $('#searchIcon').click(function () {
        var myreg = /^[1][3,4,5,7,8][0-9]{9}$/;
        if (!myreg.test($('#searchPhone').val())) {
            layer.msg('请填写有效手机号!');
            return false;
        }
        fund(1)
    })

    // 输入框失去焦点事件
    $('#searchPhone').blur(function () {
        var myreg = /^[1][3,4,5,7,8][0-9]{9}$/;
        if (!myreg.test($('#searchPhone').val())) {
            layer.msg('请填写有效手机号!');
            return false;
        }
        fund(1)
    })
</script>

</html>